<!doctype html>
<html>
  <head>
    <title>D3 sandbox</title>
    <meta charset="utf-8" />
    <script src="static/libs/d3.v2.min.js" charset="utf-8"></script>
    <script src="static/libs/underscore-min.js"></script>
    <script src="flare.json" charset="utf-8"></script>
    <style>
      circle.node {
          stroke: #fff;
          stroke-width: 3px;
      }

      line.link {
          stroke-width: 2px;
          stroke: #999;
          stroke-opacity: 0.6;
      }
    </style>
  </head>

  <body>

   <script>

var getIcon = function(node) {
  var icon = "";
  var base_dir = "static/img/icons/";

  if (node.group == "5") icon = "ws.png";
  else if (node.group == "2") icon = "db.png";
  else if (node.group == "0") icon = "lb.png";

  if (icon != "") icon = base_dir + icon;

  return icon;
}

function distanceToStartSpec(memo, all_specs, spec) {
  if(memo[spec.id]) {
    return memo[spec.id];
  }

  if(spec.id === 1){
    memo[spec.id] = 0;
    return memo[spec.id];
  }

  max_spec = _.max(spec.inputs, function(input){
    return distanceToStartSpec(memo, all_specs, specs[input]);
  });

  var scale = 20;
  var default_duration = 50;
  var max_duration = specs[max_spec].properties.estimated_duration || default_duration;
  memo[spec.id] = memo[specs[max_spec].id] + Math.log(max_duration)*scale;
  return memo[spec.id];
}

var buildNodes = function(specs, positions_memo) {
  var nodes = [];
  var spacing = { x: 50, y: 50 };

  _.each(specs, function(spec, spec_name){
    var name,
        group,
        x,
        y,
        fixed = true;
    if(spec_name === 'Start') {
      x = 20;
      y = 200;
      name = spec_name;
      group = 0;
      nodes.push({x: x, y: y, group: group, fixed: fixed, name: name})
    }

    function getY(nodes, x, group, level){
      level = level || 0;
      var y = (level * 30) + 50 + (50 * group);
      var existing_node = _.findWhere(nodes, { x: x, y: y, group: group })
      if(!existing_node) {
        return y;
      }

      return getY(nodes, x, group, level+1)
    }

    if(spec.properties){
      if(spec.properties.resource){
        group = (parseInt(spec.properties.resource) || -1) + 2;
        position = distanceToStartSpec(positions_memo, specs, spec);
        x = spacing.x + position;
        y = getY(nodes, x, group, 0);
        name = spec_name;
        var node = { name: name,
                     group: group,
                     y: y,
                     x: x,
                     fixed: fixed }
        nodes.push(node)
      } else if (!(spec_name === 'Root') && !(spec_name === 'Start')){
        group = (parseInt(specs[spec.inputs[0]].properties.resource) || -1) + 2;
        position = distanceToStartSpec(positions_memo, specs, spec);
        x = spacing.x + position;
        y = getY(nodes, x, group, 0);
        name = spec_name;
        var node = { name: name,
                     group: group,
                     y: y,
                     x: x,
                     fixed: fixed }
        nodes.push(node)
      }
    }
  });

  return nodes;
}

var buildLinks = function(specs) {
  var links = [];

  _.each(specs, function(spec, spec_name){
    if(spec.outputs){
      _.each(spec.outputs, function(output){
        source = _.findWhere(nodes, { name: spec_name })
        target = _.findWhere(nodes, { name: output })
        if(source && target) {
          l = {source: source, target: target, value: 1}
          links.push(l)
        }
      })
    }
  });

  return links;
}

var buildNetwork = function(json, width, height) {
  var color = d3.scale.category10();

  var force = d3.layout.force()
              .size([width, height]);

  var svg = d3.select("body")
              .append("svg")
              .attr("width", width)
              .attr("height", height);

  force
      .nodes(json.nodes)
      .links(json.links)
      .start()
      ;

  var links = svg.append("g").selectAll("line.link")
      .data(force.links())
      .enter().append("line")
      .attr("class", "link")
      ;

  var nodes = svg.selectAll("g.node")
      .data(force.nodes())
      .enter()
      .append("svg:g")
      .attr("class", "node")
      .call(force.drag)
      ;

  nodes.append("svg:title")
      .text(function(d) { return d.name; });

  nodes.append("svg:desc")
      .text(function(d) { return JSON.stringify(d); });

  nodes.append('circle')
      .attr("r", 8)
      .attr("class", "node")
      .style("fill", function(d) { return color(d.group); })

  nodes.append("svg:image")
      .attr("class", "circle")
      .attr("xlink:href", getIcon)
      .attr("x", "-8px")
      .attr("y", "-8px")
      .attr("width", "16px")
      .attr("height", "16px");

  force.on("tick", function() {
      links.attr("x1", function(d) { return d.source.x; })
          .attr("y1", function(d) { return d.source.y; })
          .attr("x2", function(d) { return d.target.x; })
          .attr("y2", function(d) { return d.target.y; });

      nodes.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
  });
};

specs = data.wf_spec.task_specs
var WIDTH = 1400;
var HEIGHT = 900;
var positions_memo = {}
var nodes = buildNodes(specs, positions_memo);
var links = buildLinks(specs);
var network = { nodes: nodes, links: links };
buildNetwork(network, WIDTH, HEIGHT);


   </script>

  </body>
</html>
