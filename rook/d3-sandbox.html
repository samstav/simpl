<!doctype html>
<html>
  <head>
    <title>D3 sandbox</title>
    <meta charset="utf-8" />
    <script src="static/libs/d3.v2.min.js" charset="utf-8"></script>
    <script src="static/libs/underscore-min.js"></script>
    <!-- <script src="file:///Users/Thoughtworker/development/rackspace/checkmate/task_specs.js" charset="utf-8"></script> -->
    <script src="flare.json" charset="utf-8"></script>
    <style>
      circle.node {
          stroke: #fff;
          stroke-width: 3px;
      }

      line.link {
          stroke-width: 2px;
          stroke: #999;
          stroke-opacity: 0.6;
      }
    </style>
  </head>

  <body>
    <svg id="cloud" width="1000" height="800">
    </svg>


   <script>


nodes = [];
links = [];
specs = data.wf_spec.task_specs

_.each(specs, function(spec, spec_name){
  var name,
      group,
      x,
      y,
      fixed = true;
  if(spec.properties){
    if(spec.properties.resource){
      group = parseInt(spec.properties.resource) || 0;
      if(spec.inputs.length > 0){
        x = 200;
      } else {
        x = 100;
      }
      y = 50 + (50 * group);
      name = spec_name;
      var node = { name: name,
                   group: group,
                   y: y,
                   x: x,
                   fixed: fixed }
      nodes.push(node)
    }
  }
});

_.each(specs, function(spec, spec_name){
  if(spec.outputs){
    _.each(spec.outputs, function(output){
      source = _.findWhere(nodes, { name: spec_name })
      target = _.findWhere(nodes, { name: output })
      if(source && target) {
        l = {source: source, target: target, value: 1}
        links.push(l)
      }
    })
  }
});

root2 = { nodes: nodes, links: links }












var width = 640;
var height = 480;

var color = d3.scale.category10();

var force = d3.layout.force()
    //.charge(-180)
    //.linkDistance(50)
    .size([width, height]);

var svg = d3.select("#cloud");

var jsonf = function(json) {
    force
        .nodes(json.nodes)
        .links(json.links)
        .start()
        ;

    var links = svg.append("g").selectAll("line.link")
        .data(force.links())
        .enter().append("line")
        .attr("class", "link")
        ;

    var nodes = svg.selectAll("circle.node")
        .data(force.nodes())
        .enter().append("circle")
        .attr("class", "node")
        .attr("r", 8)
        .style("fill", function(d) { return color(d.group); })
        .call(force.drag)
        ;

    nodes.append("svg:text")
        .attr("class", "nodetext")
        .attr("dx", 12)
        .attr("dy", ".35em")
        .text(function(d) { return d.name; });

    force.on("tick", function() {
        links.attr("x1", function(d) { return d.source.x; })
            .attr("y1", function(d) { return d.source.y; })
            .attr("x2", function(d) { return d.target.x; })
            .attr("y2", function(d) { return d.target.y; });

        nodes.attr("cx", function(d) { return d.x; })
            .attr("cy", function(d) { return d.y; });
    });

};
jsonf(root2);

   </script>

  </body>
</html>
