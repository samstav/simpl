# The API

The API is a **REST HTTP API**. It supports POST, PUT, GET, DELETE on:

- /blueprints[/:id]/...
- /deployments[/:id]/...
- /workflows[/:id]/...

- /environments[/:id]/...
- /providers[/:key]/...
- /resources/...

- /admin/...
- /webhooks/...
- /version

- /anonymous/blueprints[/:id]/
- /anonymous/catalog/...

*Note: not all verbs on all paths. DELETE not yet ready*

### POST & PUT

Sometimes a religious debate, but here are the semantics checkmate uses now.
Simply:

- **PUT** updates without taking any action or side effects on other resources.
  The only permitted side-effect is on theresource itsefl (for example, updating
  a last-modified field).
- **POST** can trigger actions or have side-effects (like actual server
  deployments) and can accept partial objects.

The **semantics** are:

**POST /objects** (without ID):
- creates a new object. ID is generated by checkmate and returned in the
  Location header.
- use it to create objects without fear of ID conflicts

**POST /objects/:id**
- Update an existing object. Partial updates are supported (i.e. I can POST only
  the name to rename the object). Could trigger side effects, like running a
  workflow.
- Use it to modify parts of an object.

**PUT /objects/:id**
- Overwrites the object completely. Does not trigger side effects, but will
  validate data (especially id and tenant_id fields).
- Use it to store something in checkmate (ex. a deployment exported from another
  instance of checkmate)

**GET** will sometimes add the object ID and tenant ID if the underlying store
does not provide them. This is so that the object can be identified when parsed
later.
- On plurals (blueprints, components, deployments, environments, workflows), if
  a `GET` request resuts in no records an empty collection will be returned.
- On singulars (blueprints/<id>, deployments/<id>, etc.), if a `GET` request
  results in nothing found an HTTP 404 response will be received.

### JSON, YAML, and XML

Objects are returned as JSON by default, but YAML is also supported
(content-type: application/x-yaml) HTML output is also supported if the server
is started with a `--with-ui` parameter.

XML is not yet supported.

### Errors

Errors will be returned in the format requested (YAML or JSON, with JSON being
the default).

The body will contain an object (shown here as yaml):

    error:             # this is the wrapper for the returned error object
        code:          # the HTTP error code (ex. 404)
        message:       # the HTTP error code message (ex. Not Found)
        description:   # the plain english, user-friendly description. Use
                         this to to surface a UI/CLI non-technical message
        reason:        # (optional) may contain additional technical information
                         to help a technically knowledgable user troubleshoot
                         the problem

###Special cases and considerations

All objects should have a root key with the name of the class. Ex.
`{"blueprint": {"id": 1}}`. However, checkmate will permit objects without the
root if they are provided. Example:

    PUT /blueprints/2 {"id": 2}

Checkmate will fill in the id, status, tenant_id, and creation date of posted
objects. For puts, these value must be supplied and must be correct (i.e.
matching the tenant and id in the URL).

YAML supports references within a document. If a deployment is in YAML format
and is using references, the references can be provided under a key called
'includes'. This can be used, for example, to create a new deployment passing in
all the necessary components, blueprints, environments, etc... (or references to
them).

Some commands can be issued with a '+command' URL. Example:

      /workflows/wf1000/+execute

All calls are supported flat off of the root or under a tenant ID. Calls off of
the root require administrative privileges and will return all objects from all
tenants (ex. /environments vs /T1000/environments)

All calls to GET /deployments and GET /workflows may be optionally paginated by
`offset` and `limit`. `limit` will be capped at 100 if a higher value is passed.


### List of all calls
*:tid* is the tenant ID and is required.

    GET /version[.wadl | .json | .yaml]

    GET/POST /:tid/environments
    PUT/GET/POST /:tid/environments/:id

    GET /:tid/environments/:id/providers
    GET /:tid/environments/:id/providers/:pid
    GET /:tid/environments/:id/providers/:pid/catalog
    GET /:tid/environments/:id/providers/:pid/catalog/:cid

    GET  /:tid/blueprints/[?offset=OFFSET&limit=LIMIT&details=1]
    GET/PUT  /:tid/blueprints/:id
    POST  /:tid/blueprints/

    GET  /:tid/deployments/[?offset=OFFSET&limit=LIMIT&show_deleted=1]
    POST /:tid/deployments
    POST /:tid/deployments/+parse[?check_limits=1&check_access=1]
    POST /:tid/deployments/+preview
    POST/GET /:tid/deployments/:id/+check
    POST/GET /:tid/deployments/:id/+plan
    POST/GET /:tid/deployments/:id/+deploy
    POST/GET /:tid/deployments/:id/+clone
    POST/GET /:tid/deployments/:id/+sync
    POST/GET /:tid/deployments/:id/+add-nodes
    POST/GET /:tid/deployments/:id/+delete-nodes
    PUT/GET/POST /:tid/deployments/:id
    DELETE /:tid/deployments/:id[?force=1]
    GET /:tid/deployments/:id/status
    POST/GET /:tid/deployments/:id/secrets
    GET /:tid/deployments/:id/resources
    GET /:tid/deployments/:id/resources/:rid
    POST/GET /:tid/deployments/:id/resources/:r_id/+take-offline
    POST/GET /:tid/deployments/:id/resources/:r_id/+bring-online

    GET  /:tid/workflows/[?offset=OFFSET&limit=LIMIT]
    POST /:tid/workflows
    PUT/GET/POST /:tid/workflows/:id
    GET /:tid/workflows/:id/status
    GET/POST /:tid/workflows/:id/+execute
    GET/POST /:tid/workflows/:id/+pause
    GET/POST /:tid/workflows/:id/+resume

    GET/POST /:tid/workflows/:id/tasks/:task_id
    POST /:tid/workflows/:id/tasks/:task_id/+execute
    POST /:tid/workflows/:id/tasks/:task_id/+resubmit

    GET /:tid/providers
    GET /:tid/providers/catalog
    GET /:tid/providers/:pid
    GET /:tid/providers/:pid/catalog
    GET /:tid/providers/:pid/catalog/:cid
    GET /:tid/providers/:pid/resources

    GET /:tid/resources[?id=<lcomma-separated ist>&provider=<key>&type=<resource type>]

    # If the server is started with --with-admin, the following calls are
    # available to admin users:

    GET /admin/status/celery
    GET /admin/status/libraries
    GET /admin/deployments/[?offset=OFFSET&limit=LIMIT?show_deleted=1]
    PUT /admin/tenants
    GET /admin/tenants[/:tid]
    GET /admin/tenants?tag=foo&tag=bar
    GET /admin/cache/blueprints
    GET /admin/blueprints/local
    GET /admin/blueprints/github

    # If the server is started with --with-simulator, the following calls are
    # available:

    POST /:tid/deployments/simulate

    # If the server is started with --webhook, the following calls are
    # available:

    POST /webhooks/blueprints
    
    # Anonymous paths are enabled by default. Disabled by starting the 
    # application using --without-anonymous
    
    GET /anonymous/blueprints
    GET /anonymous/blueprints/:id/
    GET /anonymous/catalog/
